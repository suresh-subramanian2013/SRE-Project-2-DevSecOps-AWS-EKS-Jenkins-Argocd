name: CI/CD Pipeline

on:
  push:
    branches: [ dev, qa, prod ]
  pull_request:
    branches: [ dev, qa, prod ]

env:
  AWS_DEFAULT_REGION: us-east-1
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  SNYK_SEVERITY_THRESHOLD: high

jobs:
  # ============================================================
  # JOB 1: Platform Check - Validate EKS Cluster Health
  # ============================================================
  platform-check:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/qa' || github.ref == 'refs/heads/prod'
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Update kubeconfig
        run: |
          EKS_CLUSTER_NAME="cicd-pipeline-${{ github.ref_name }}"
          aws eks update-kubeconfig --region ${{ env.AWS_DEFAULT_REGION }} --name $EKS_CLUSTER_NAME

      - name: Check EKS cluster status
        run: ./scripts/check-eks-cluster.sh

  # ============================================================
  # JOB 2: Validate - Dockerfile, K8s Syntax, Policies, SAST
  # ============================================================
  validate-dockerfile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          ignore: DL3008,DL3009

  validate-kubernetes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kubeconform
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Kubernetes manifests
        run: ./scripts/validate-k8s-manifests.sh

  validate-kyverno-policies:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Test Kyverno policies
        uses: nirmata/kyverno-action@v0.5.5
        with:
          policies: kyverno-policies/
          resources: helm-chart/templates/deployment.yaml

  sast-snyk:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Run Snyk SAST scan
        uses: snyk/actions/maven@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=${{ env.SNYK_SEVERITY_THRESHOLD }}

      - name: Snyk monitor
        uses: snyk/actions/maven@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=${{ env.SNYK_SEVERITY_THRESHOLD }} monitor
        continue-on-error: true

  # ============================================================
  # JOB 3: Build Artifact - Maven Build
  # ============================================================
  build-maven:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'openjdk'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: maven-artifacts
          path: |
            target/*.jar
            target/*.war
          retention-days: 1

  # ============================================================
  # JOB 4: Package - Build Docker Image, Helm Chart, Push to ECR
  # ============================================================
  package-docker:
    needs: build-maven
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/qa' || github.ref == 'refs/heads/prod'
    permissions:
      id-token: write
      contents: read
    outputs:
      image-tag: ${{ steps.image.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Maven artifacts
        uses: actions/download-artifact@v3
        with:
          name: maven-artifacts

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image
        id: image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ github.event.repository.name }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:${{ github.ref_name }}-$IMAGE_TAG
          echo "tag=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ github.event.repository.name }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ github.ref_name }}-$IMAGE_TAG

  package-helm:
    needs: package-docker
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/qa' || github.ref == 'refs/heads/prod'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: latest

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: Login to Amazon ECR (Helm)
        run: |
          aws ecr get-login-password --region ${{ env.AWS_DEFAULT_REGION }} | helm registry login --username AWS --password-stdin ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_DEFAULT_REGION }}.amazonaws.com

      - name: Package and push Helm chart
        run: |
          cd helm-chart
          helm package . --version ${{ github.sha }} --app-version ${{ github.sha }}
          helm push *.tgz oci://${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_DEFAULT_REGION }}.amazonaws.com/helm-charts

  # ============================================================
  # JOB 5: Scan Container Image with Snyk
  # ============================================================
  scan-container:
    needs: package-docker
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/qa' || github.ref == 'refs/heads/prod'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Pull Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ github.event.repository.name }}
          IMAGE_TAG: ${{ github.sha }}
        run: docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Run Snyk container scan
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ needs.package-docker.outputs.image-tag }}
          args: --severity-threshold=${{ env.SNYK_SEVERITY_THRESHOLD }}

      - name: Snyk container monitor
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ needs.package-docker.outputs.image-tag }}
          args: monitor --severity-threshold=${{ env.SNYK_SEVERITY_THRESHOLD }}
        continue-on-error: true

  # ============================================================
  # JOB 6: Promote to Dev/QA/Prod - ArgoCD Integration
  # ============================================================
  promote:
    needs: [ scan-container, package-helm ]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/qa' || github.ref == 'refs/heads/prod'
    steps:
      - uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global user.email "ci-cd@github.com"
          git config --global user.name "GitHub Actions"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: Promote to ${{ github.ref_name }}
        run: |
          ENVIRONMENT=${{ github.ref_name }}
          HELM_CHART_VERSION=${{ github.sha }}
          IMAGE_TAG=${{ github.sha }}
          
          echo "Promoting to $ENVIRONMENT cluster..."
          ./scripts/update-config-repo.sh $ENVIRONMENT $HELM_CHART_VERSION $IMAGE_TAG

      - name: Check ArgoCD sync status
        continue-on-error: true
        run: |
          sleep 30
          curl -f http://argocd.example.com/api/v1/applications/${{ github.event.repository.name }}-${{ github.ref_name }} || echo "ArgoCD API check skipped"

      - name: Trigger Jenkins tests (QA only)
        if: github.ref == 'refs/heads/qa'
        continue-on-error: true
        run: |
          curl -X POST "${{ secrets.JENKINS_URL }}/job/qa-tests/build" \
            --user "${{ secrets.JENKINS_USER }}:${{ secrets.JENKINS_TOKEN }}" || echo "Jenkins trigger skipped"

  # Manual approval gates for QA and Prod
  approval-gate-qa:
    if: github.ref == 'refs/heads/qa' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: qa
      url: https://qa.example.com
    steps:
      - name: Await approval
        run: echo "Deployment to QA requires manual approval"

  approval-gate-prod:
    if: github.ref == 'refs/heads/prod' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: prod
      url: https://prod.example.com
    steps:
      - name: Await approval
        run: echo "Deployment to Production requires manual approval"
